<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - OMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .sidebar {
            background: #2c3e50;
            color: white;
            height: 100vh;
            position: fixed;
            width: 250px;
        }
        .sidebar .nav-link {
            color: #bdc3c7;
            padding: 12px 20px;
            border-left: 3px solid transparent;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background: #34495e;
            border-left-color: #3498db;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .order-status-badge {
            font-size: 0.75em;
            padding: 0.35em 0.65em;
        }
        .loading-spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .order-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 5px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-3">
            <h4 class="text-white mb-0">
                <i class="fas fa-shopping-bag me-2"></i>OMS Customer
            </h4>
        </div>
        <nav class="nav flex-column">
            <a class="nav-link" href="customer-dashboard.html">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </a>
            <a class="nav-link" href="customer-products.html">
                <i class="fas fa-box me-2"></i>Products
            </a>
            <a class="nav-link active" href="customer-orders.html">
                <i class="fas fa-shopping-cart me-2"></i>My Orders
            </a>
            <a class="nav-link" href="customer-track.html">
                <i class="fas fa-map-marker-alt me-2"></i>Track Order
            </a>
            <a class="nav-link" href="customer-profile.html">
                <i class="fas fa-user me-2"></i>Profile
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
            <div class="container-fluid">
                <h4 class="mb-0">
                    <i class="fas fa-shopping-cart text-primary me-2"></i>My Orders
                </h4>
                <div class="navbar-nav ms-auto">
                    <span class="user-info">
                        <i class="fas fa-user-circle me-2"></i>
                        <span id="userName">Loading...</span>
                    </span>
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2>My Orders</h2>
                <p class="text-muted">View and track your order history</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" onclick="refreshOrders()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='customer-products.html'">
                        <i class="fas fa-shopping-bag me-2"></i>Continue Shopping
                    </button>
                </div>
            </div>
        </div>

        <!-- Order Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Orders</h5>
                        <h2 id="totalOrders">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">Delivered</h5>
                        <h2 id="deliveredOrders">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h5 class="card-title">Pending</h5>
                        <h2 id="pendingOrders">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h5 class="card-title">Shipped</h5>
                        <h2 id="shippedOrders">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders List -->
        <div id="loadingSpinner" class="text-center py-5">
            <div class="loading-spinner mb-3"></div>
            <p>Loading your orders...</p>
        </div>

        <div id="ordersList" style="display: none;">
            <!-- Orders will be loaded here -->
        </div>

        <div id="noOrdersMessage" class="text-center py-5" style="display: none;">
            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Orders Yet</h5>
            <p class="text-muted">Start shopping to see your orders here.</p>
            <button class="btn btn-primary" onclick="window.location.href='customer-products.html'">
                <i class="fas fa-shopping-bag me-2"></i>Start Shopping
            </button>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details - #<span id="modalOrderId"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailsContent">
                    <!-- Order details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Service for Customer Orders
        class CustomerOrderApiService {
            static baseUrl = 'http://localhost:8080/api';

            static async request(endpoint, options = {}) {
                const url = `${this.baseUrl}${endpoint}`;
                
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    ...options
                };

                try {
                    const response = await fetch(url, config);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }

            // Order methods
            static async getUserOrders(userId) {
                return await this.request(`/orders/user/${userId}`);
            }

            static async getOrderById(id) {
                return await this.request(`/orders/${id}`);
            }

            static async updateOrderStatus(orderId, status) {
                return await this.request(`/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: status })
                });
            }
        }

        // Authentication functions
        function checkAuthentication() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser') || '{}');
            
            if (!currentUser.id) {
                window.location.href = 'login.html';
                return false;
            }
            
            // Update user info in navbar
            document.getElementById('userName').textContent = currentUser.name || currentUser.email;
            
            return true;
        }

        function getCurrentUserInfo() {
            return JSON.parse(localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser') || '{}');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear user data from storage
                localStorage.removeItem('currentUser');
                sessionStorage.removeItem('currentUser');
                
                // Show logout message
                alert('You have been logged out successfully.');
                
                // Redirect to login page
                window.location.href = 'login.html';
            }
        }

        // Order ID Generator
        class OrderIdGenerator {
            static generateOrderId() {
                // Generate a unique order ID with timestamp and random number
                const timestamp = Date.now().toString().slice(-6);
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return parseInt(`100${timestamp}${random}`);
            }

            static getNextOrderId() {
                // Get the next order ID from localStorage or generate new one
                let lastOrderId = localStorage.getItem('lastOrderId');
                if (!lastOrderId) {
                    lastOrderId = this.generateOrderId();
                } else {
                    lastOrderId = parseInt(lastOrderId) + 1;
                }
                localStorage.setItem('lastOrderId', lastOrderId);
                return lastOrderId;
            }
        }

        class CustomerOrderManager {
            constructor() {
                this.currentUser = getCurrentUserInfo();
                this.userId = this.currentUser.id || this.currentUser.userId;
                this.orders = [];
                this.init();
            }

            async init() {
                await this.loadOrders();
            }

            async loadOrders() {
                try {
                    this.showLoading();
                    
                    // First try to load from localStorage (for demo purposes)
                    const localOrders = this.getOrdersFromLocalStorage();
                    if (localOrders && localOrders.length > 0) {
                        this.orders = localOrders;
                        this.renderOrders();
                        this.updateStats();
                        this.hideLoading();
                        return;
                    }
                    
                    // Then try to load real orders from API
                    this.orders = await CustomerOrderApiService.getUserOrders(this.userId);
                    this.renderOrders();
                    this.updateStats();
                    this.hideLoading();
                } catch (error) {
                    console.error('Error loading orders from API:', error);
                    // Fallback to mock data
                    this.orders = await this.getMockOrders();
                    this.renderOrders();
                    this.updateStats();
                    this.hideLoading();
                    this.showError('Using demo data - API connection failed');
                }
            }

            getOrdersFromLocalStorage() {
                try {
                    const orders = JSON.parse(localStorage.getItem('oms_orders')) || [];
                    // Filter orders for current user
                    return orders.filter(order => order.userId === this.userId);
                } catch (error) {
                    console.error('Error loading orders from localStorage:', error);
                    return [];
                }
            }

            async getMockOrders() {
                // Fallback mock data for current user
                const userId = this.userId;
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                return [
                    {
                        id: 1001,
                        userId: userId,
                        totalAmount: 2399.99,
                        status: "DELIVERED",
                        orderDate: "2024-01-15T10:30:00Z",
                        items: [
                            { productId: 1, name: "MacBook Pro 16", quantity: 1, price: 2399.99 }
                        ],
                        shippingAddress: "123 Main St, New York, NY 10001",
                        paymentMethod: "Credit Card"
                    },
                    {
                        id: 1002,
                        userId: userId,
                        totalAmount: 1349.98,
                        status: "SHIPPED",
                        orderDate: "2024-01-16T14:20:00Z",
                        items: [
                            { productId: 2, name: "iPhone 15 Pro", quantity: 1, price: 999.99 },
                            { productId: 3, name: "Sony Headphones", quantity: 1, price: 349.99 }
                        ],
                        shippingAddress: "123 Main St, New York, NY 10001",
                        paymentMethod: "PayPal"
                    },
                    {
                        id: 1003,
                        userId: userId,
                        totalAmount: 599.99,
                        status: "PENDING",
                        orderDate: "2024-01-17T09:15:00Z",
                        items: [
                            { productId: 4, name: "iPad Air", quantity: 1, price: 599.99 }
                        ],
                        shippingAddress: "123 Main St, New York, NY 10001",
                        paymentMethod: "Credit Card"
                    }
                ];
            }

            renderOrders() {
                const ordersList = document.getElementById('ordersList');
                const noOrdersDiv = document.getElementById('noOrdersMessage');

                if (this.orders.length === 0) {
                    ordersList.style.display = 'none';
                    noOrdersDiv.style.display = 'block';
                    return;
                }

                noOrdersDiv.style.display = 'none';
                ordersList.style.display = 'block';

                // Sort orders by date (newest first)
                const sortedOrders = this.orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

                ordersList.innerHTML = sortedOrders.map(order => `
                    <div class="card order-card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <h6 class="mb-1">Order #${order.id || order.orderId}</h6>
                                    <small class="text-muted">${this.formatDate(order.orderDate)}</small>
                                </div>
                                <div class="col-md-2">
                                    <h6 class="mb-0">$${order.totalAmount.toFixed(2)}</h6>
                                    <small class="text-muted">Total</small>
                                </div>
                                <div class="col-md-2">
                                    <span class="order-status-badge ${this.getStatusBadgeClass(order.status)}">
                                        ${order.status}
                                    </span>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">
                                        ${order.items ? order.items.length + ' item(s)' : '1 item'} â€¢ ${order.paymentMethod || 'Credit Card'}
                                    </small>
                                </div>
                                <div class="col-md-2 text-end">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="viewOrderDetails(${order.id || order.orderId})">
                                        <i class="fas fa-eye"></i> Details
                                    </button>
                                    ${(order.status === 'PENDING' || order.status === 'Pending') ? `
                                        <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder(${order.id || order.orderId})">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updateStats() {
                const totalOrders = this.orders.length;
                const deliveredOrders = this.orders.filter(o => 
                    o.status === 'DELIVERED' || o.status === 'Delivered'
                ).length;
                const pendingOrders = this.orders.filter(o => 
                    o.status === 'PENDING' || o.status === 'Pending'
                ).length;
                const shippedOrders = this.orders.filter(o => 
                    o.status === 'SHIPPED' || o.status === 'Shipped'
                ).length;

                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('deliveredOrders').textContent = deliveredOrders;
                document.getElementById('pendingOrders').textContent = pendingOrders;
                document.getElementById('shippedOrders').textContent = shippedOrders;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            getStatusBadgeClass(status) {
                const statusMap = {
                    'PENDING': 'bg-warning text-dark',
                    'Pending': 'bg-warning text-dark',
                    'SHIPPED': 'bg-primary',
                    'Shipped': 'bg-primary',
                    'DELIVERED': 'bg-success',
                    'Delivered': 'bg-success',
                    'CANCELLED': 'bg-danger',
                    'Cancelled': 'bg-danger'
                };
                return statusMap[status] || 'bg-secondary';
            }

            showLoading() {
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('ordersList').style.display = 'none';
                document.getElementById('noOrdersMessage').style.display = 'none';
            }

            hideLoading() {
                document.getElementById('loadingSpinner').style.display = 'none';
            }

            showError(message) {
                console.error(message);
            }
        }

        // Global functions
        let orderManager;

        function viewOrderDetails(orderId) {
            // Redirect to customer-track.html with order ID as parameter
            window.location.href = `customer-track.html?order=${orderId}`;
        }

        function displayOrderDetails(order) {
            const orderId = order.id || order.orderId;
            document.getElementById('modalOrderId').textContent = orderId;
            
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Order Information</h6>
                        <p><strong>Order ID:</strong> #${orderId}</p>
                        <p><strong>Order Date:</strong> ${orderManager.formatDate(order.orderDate)}</p>
                        <p><strong>Total Amount:</strong> $${order.totalAmount.toFixed(2)}</p>
                        <p><strong>Status:</strong> 
                            <span class="order-status-badge ${orderManager.getStatusBadgeClass(order.status)}">
                                ${order.status}
                            </span>
                        </p>
                        <p><strong>Payment Method:</strong> ${order.paymentMethod || 'Credit Card'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Shipping Address</h6>
                        <p>${order.shippingAddress || '123 Main St, New York, NY 10001'}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Order Items</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(order.items || [{name: 'Product', quantity: 1, price: order.totalAmount}]).map(item => `
                                        <tr>
                                            <td>${item.name}</td>
                                            <td>${item.quantity}</td>
                                            <td>$${item.price.toFixed(2)}</td>
                                            <td>$${(item.quantity * item.price).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                    <tr class="table-active">
                                        <td colspan="3" class="text-end"><strong>Grand Total:</strong></td>
                                        <td><strong>$${order.totalAmount.toFixed(2)}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ${(order.status === 'PENDING' || order.status === 'Pending') ? `
                <div class="row mt-3">
                    <div class="col-12 text-end">
                        <button class="btn btn-danger" onclick="cancelOrder(${orderId})">
                            <i class="fas fa-times me-2"></i>Cancel Order
                        </button>
                    </div>
                </div>
                ` : ''}
            `;

            document.getElementById('orderDetailsContent').innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        }

        async function cancelOrder(orderId) {
            if (confirm('Are you sure you want to cancel this order? This action cannot be undone.')) {
                try {
                    // Update order status via API
                    await CustomerOrderApiService.updateOrderStatus(orderId, 'CANCELLED');
                    
                    // Update local data
                    const order = orderManager.orders.find(o => o.id === orderId || o.orderId === orderId);
                    if (order) {
                        order.status = 'CANCELLED';
                        orderManager.renderOrders();
                        orderManager.updateStats();
                    }
                    
                    // Update localStorage
                    updateOrderStatusInLocalStorage(orderId, 'CANCELLED');
                    
                    alert('Order cancelled successfully!');
                    
                    // Close modal if open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal'));
                    if (modal) {
                        modal.hide();
                    }
                } catch (error) {
                    console.error('Error cancelling order:', error);
                    alert('Failed to cancel order: ' + error.message);
                }
            }
        }

        function updateOrderStatusInLocalStorage(orderId, status) {
            try {
                const orders = JSON.parse(localStorage.getItem('oms_orders')) || [];
                const orderIndex = orders.findIndex(o => o.id === orderId || o.orderId === orderId);
                if (orderIndex !== -1) {
                    orders[orderIndex].status = status;
                    localStorage.setItem('oms_orders', JSON.stringify(orders));
                }
            } catch (error) {
                console.error('Error updating order status in localStorage:', error);
            }
        }

        function refreshOrders() {
            orderManager.loadOrders();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuthentication()) {
                return;
            }
            orderManager = new CustomerOrderManager();
        });
    </script>
</body>
</html>